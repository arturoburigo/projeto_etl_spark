# 📈 KPIs and Metrics

## 📋 Overview

The system automatically calculates a comprehensive set of **KPIs (Key Performance Indicators)** and **operational metrics** that provide valuable insights into the logistics and transportation business performance. All indicators are automatically updated through the ETL pipeline and stored in the Gold layer for consumption by BI tools.

---

## 🎯 Main KPIs

### 🚚 **1. On-Time Delivery (OTD)**

**Description**: Percentage of deliveries completed within the established deadline.

**Formula**: 
```sql
OTD = (On-Time Deliveries / Total Deliveries) × 100
```

**Implementation**:
```python
kpi_otd = fact_deliveries.withColumn("on_time",
    (col("actual_end_date_key") <= col("estimated_end_date_key")) | 
    (col("estimated_end_date_key").isNull())
).agg(
    (sum(when(col("on_time") == True, 1).otherwise(0)) / count("*") * 100)
    .alias("on_time_delivery_percentage")
)
```

**Business Targets**:
- 🎯 **Excellent**: > 95%
- ✅ **Good**: 90-95%
- ⚠️ **Warning**: 80-90%
- 🚨 **Critical**: < 80%

**Update Frequency**: Daily  
**Granularity**: By day, week, month, customer, route

---

### 💰 **2. Average Freight Cost per Route**

**Description**: Average transportation cost per kilometer on each route.

**Formula**: 
```sql
Cost per KM = Total Freight Value / Route Distance (KM)
```

**Implementation**:
```python
kpi_route_cost = fact_deliveries.join(dim_route, 
    fact_deliveries["route_origin_id"] == dim_route["route_origin_id"], "left"
).groupBy(
    dim_route["route_name"], 
    dim_route["origin"], 
    dim_route["destination"],
    dim_route["distance_km"]
).agg(
    avg("freight_value").alias("average_freight_cost"),
    (avg("freight_value") / first("distance_km")).alias("cost_per_km")
)
```

**Available Analysis**:
- 📊 **By Route**: Identification of most/least profitable routes
- 📈 **Temporal Trend**: Cost evolution over time
- 🔍 **Benchmarking**: Comparison between similar routes
- 💡 **Optimization**: Identification of improvement opportunities

**Update Frequency**: Weekly  
**Granularity**: By route, region, cargo type

---

### 🚛 **3. Fleet Utilization**

**Description**: Analysis of vehicle utilization by type and performance.

**Calculated Metrics**:
- Total deliveries per vehicle type
- Fleet occupancy rate
- Average mileage per vehicle
- Average transit time

**Implementation**:
```python
kpi_fleet = fact_deliveries.join(dim_vehicle, 
    fact_deliveries["vehicle_origin_id"] == dim_vehicle["vehicle_origin_id"], "left"
).groupBy(
    dim_vehicle["vehicle_type"],
    dim_vehicle["brand"],
    dim_vehicle["cargo_capacity_kg"]
).agg(
    count("*").alias("total_deliveries"),
    sum("cargo_weight_kg").alias("total_weight_transported"),
    avg("cargo_weight_kg").alias("average_weight_per_delivery"),
    (sum("cargo_weight_kg") / first("cargo_capacity_kg") * 100).alias("average_occupancy_rate")
)
```

**Generated Insights**:
- 🎯 **Efficiency by Type**: Trucks vs Vans vs Utility vehicles
- 📊 **Capacity**: Cargo occupancy rate
- 🔄 **Turnover**: Usage frequency per vehicle
- 💰 **ROI**: Return on investment per vehicle

**Update Frequency**: Monthly  
**Granularity**: By vehicle, type, brand, region

---

### 💼 **4. Revenue per Customer**

**Description**: Total freight value generated by each customer and profitability analysis.

**Calculated Metrics**:
- Total freight value per customer
- Average ticket per delivery
- Shipping frequency
- Customer profitability

**Implementation**:
```python
kpi_customer = fact_deliveries.join(dim_customer, 
    fact_deliveries["sender_customer_origin_id"] == dim_customer["customer_origin_id"], "left"
).groupBy(
    dim_customer["customer_name"],
    dim_customer["customer_type"],
    dim_customer["city"],
    dim_customer["state"]
).agg(
    sum("freight_value").alias("total_freight_value"),
    count("*").alias("total_deliveries"),
    avg("freight_value").alias("average_ticket"),
    sum("cargo_weight_kg").alias("total_weight_shipped")
)
```

**Customer Segmentation**:
- 🥇 **Premium**: > $50,000/month
- 🥈 **Gold**: $20,000 - $50,000/month  
- 🥉 **Silver**: $5,000 - $20,000/month
- 📊 **Standard**: < $5,000/month

**Update Frequency**: Monthly  
**Granularity**: By customer, segment, region, type

---

## 📊 Operational Metrics

### 📅 **Temporal Metrics**

#### **Monthly Total Deliveries**
```python
metric_deliveries_month = fact_deliveries.join(dim_date, 
    fact_deliveries["delivery_start_date_key"] == dim_date["date_key"], "left"
).groupBy(
    dim_date["year"], 
    dim_date["month"],
    dim_date["month_name"]
).agg(
    count("*").alias("total_deliveries"),
    sum("freight_value").alias("total_revenue"),
    avg("freight_value").alias("average_ticket")
).orderBy("year", "month")
```

#### **Total Weight Transported per Month**
```python
metric_weight_month = fact_deliveries.join(dim_date, 
    fact_deliveries["delivery_start_date_key"] == dim_date["date_key"], "left"
).groupBy(
    dim_date["year"], 
    dim_date["month"]
).agg(
    sum("cargo_weight_kg").alias("total_weight_kg"),
    avg("cargo_weight_kg").alias("average_weight_kg"),
    count("*").alias("total_deliveries")
).orderBy("year", "month")
```

### 🔧 **Maintenance Metrics**

#### **Maintenance Cost per Vehicle**
```python
metric_maintenance = fact_maintenance.join(dim_vehicle,
    fact_maintenance["vehicle_origin_id"] == dim_vehicle["vehicle_origin_id"], "left"
).groupBy(
    dim_vehicle["license_plate"],
    dim_vehicle["model"],
    dim_vehicle["manufacture_year"]
).agg(
    sum("maintenance_cost").alias("total_maintenance_cost"),
    count("*").alias("total_maintenances"),
    avg("maintenance_cost").alias("average_maintenance_cost"),
    sum("downtime_hours").alias("total_downtime")
)
```

#### **Fuel Efficiency**
```python
metric_fuel = fact_refueling.join(dim_vehicle,
    fact_refueling["vehicle_origin_id"] == dim_vehicle["vehicle_origin_id"], "left"
).groupBy(
    dim_vehicle["license_plate"],
    dim_vehicle["vehicle_type"]
).agg(
    sum("liters").alias("total_liters"),
    sum("total_value").alias("total_fuel_cost"),
    avg("total_value" / "liters").alias("average_price_per_liter")
)
```

---

## 📈 Dashboards and Visualizations

### 🎛️ **Executive Dashboard**

**Main KPIs**:
- 📊 On-Time Delivery (gauge chart)
- 💰 Monthly revenue (line chart)
- 🚛 Fleet utilization (bar chart)
- 📈 Operational trends (combo chart)

**Available Filters**:
- 📅 Period (day, week, month, year)
- 🌍 Region (state, city)
- 👥 Customer (individual, segment)
- 🚚 Vehicle type

### 📊 **Operational Dashboard**

**Detailed Metrics**:
- 🗺️ Delivery map by region
- ⏱️ Average delivery time by route
- 📦 Cargo volume by type
- 🔧 Fleet maintenance status

### 💰 **Financial Dashboard**

**Financial Analysis**:
- 💵 Revenue by customer/region/period
- 📊 Profit margin by route
- 💸 Operational costs (fuel, maintenance, fines)
- 📈 Projections and trends

---

## 🎯 Alerts and Notifications

### 🚨 **Critical Alerts**

**On-Time Delivery < 80%**:
```python
if otd_percentage < 80:
    send_alert("CRITICAL: OTD below 80%", 
               recipients=["management@company.com"])
```

**Cost per KM above benchmark**:
```python
if cost_km > benchmark_cost_km * 1.2:
    send_alert("WARNING: Cost per KM 20% above benchmark", 
               recipients=["operations@company.com"])
```

### ⚠️ **Warning Alerts**

- 📈 **Anomalous delivery volume** (> 150% of average)
- 🔧 **Increase in maintenance costs** (> 20% from previous month)
- ⛽ **Excessive fuel consumption** per vehicle
- 🚨 **Increase in fines** per driver/vehicle

---

## 🔍 Advanced Analytics

### 📊 **Trend Analysis**

**Seasonality**:
```python
# Seasonal pattern analysis
seasonality = fact_deliveries.join(dim_date,
    fact_deliveries["delivery_start_date_key"] == dim_date["date_key"], "left"
).groupBy(
    dim_date["month"],
    dim_date["month_name"]
).agg(
    count("*").alias("total_deliveries"),
    avg("freight_value").alias("average_ticket")
).orderBy("month")
```

**YoY Growth (Year over Year)**:
```python
# Year over year comparison
yoy_growth = fact_deliveries.join(dim_date,
    fact_deliveries["delivery_start_date_key"] == dim_date["date_key"], "left"
).groupBy(
    dim_date["year"],
    dim_date["month"]
).agg(
    count("*").alias("total_deliveries"),
    sum("freight_value").alias("total_revenue")
).withColumn("growth_percentage", 
    (col("total_revenue") - lag("total_revenue").over(window)) / 
    lag("total_revenue").over(window) * 100
)
```

### 🎯 **Performance Analysis**

**Driver Efficiency**:
```python
driver_performance = fact_deliveries.join(dim_driver,
    fact_deliveries["driver_origin_id"] == dim_driver["driver_origin_id"], "left"
).groupBy(
    dim_driver["driver_name"]
).agg(
    count("*").alias("total_deliveries"),
    (sum(when(col("delivery_status") == "Delivered", 1).otherwise(0)) / count("*") * 100)
    .alias("success_rate"),
    avg("freight_value").alias("average_revenue_per_delivery")
)
```

---

## 📋 KPI Catalog

| KPI | Description | Formula | Frequency | Target |
|-----|-------------|---------|-----------|--------|
| **On-Time Delivery** | % deliveries on time | (On-Time Deliveries / Total) × 100 | Daily | > 95% |
| **Cost per KM** | Average cost per kilometer | Freight Value / Distance KM | Weekly | < $2.50/km |
| **Occupancy Rate** | % capacity utilized | Weight Transported / Capacity × 100 | Monthly | > 80% |
| **Revenue per Customer** | Revenue generated per customer | Σ Freight Value per Customer | Monthly | 10% Growth |
| **Average Ticket** | Average value per delivery | Σ Freight Value / # Deliveries | Monthly | > $500 |
| **Average Delivery Time** | Average time for delivery | Avg (End Date - Start Date) | Weekly | < 48h |
| **Damage Rate** | % deliveries with issues | Deliveries with Issues / Total × 100 | Monthly | < 2% |
| **Fuel Consumption** | Liters per 100km | (Liters / KM Driven) × 100 | Monthly | < 35L/100km |

---

## 🚀 Future Developments

### 📊 **Planned KPIs**

- 🤖 **Demand Prediction**: ML to predict delivery volume
- 🎯 **Satisfaction Score**: Based on customer feedback  
- 🌱 **Carbon Footprint**: CO₂ emissions per delivery
- 📱 **Logistics NPS**: Net Promoter Score specific to logistics

### 🔮 **Advanced Analytics**

- 🧠 **Machine Learning**: Predictive models for route optimization
- 📈 **Forecasting**: Demand and capacity prediction
- 🎯 **Optimization**: Algorithms for optimal resource allocation
- 📊 **Real-time Analytics**: Real-time dashboards

---

All these KPIs and metrics are automatically calculated by the ETL pipeline and made available in the Gold layer for consumption by Business Intelligence tools, ensuring accurate and up-to-date insights for strategic decision-making.